<!DOCTYPE html>
<html>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154360458-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154360458-1');
</script>
  <head>
      <link rel="shortcut icon" href="assets/favicon.ico"/>
      <link rel="bookmark" href="assets/favicon.ico"/>

      <script data-ad-client="ca-pub-6564736746698681" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  Elasticserach 的操作新手村 &ndash; 拿鐵派的馬克 Blog

    </title>
    
    <meta content="elasticsearch" name="keywords">
    
    
    <meta name="description" property="og:description" content="本篇文章中，我們將要很快速的學習以下幾個重點:
 elasticsearch 的基本觀念。 使用 docker 建立 elastisearch 服務。 新增 document。 取得 document。 修改 document。 搜尋 document。  elasticsearch 的基本觀念 Elasticserach 是一種分散式的搜尋引擎，它非常適合用來處理大量資料的搜尋與分析，像 github 就是拿他來搜尋它們所有的程式碼，而且它也提供了豐富的 restful api 來給我們進行操作。
Elasticserach 有這和關聯式資料庫相似的結構，如下圖。
所以假設我們要新增一筆在 markcorp 某一位員工的文檔會長的如下:
index: markcorp type: employee { id: 123 name: ‘Mark’, age: 18 } 然後當我們要去 ES 尋找這筆資料時，就可以使用它提供的 Restful API 來直接尋找:
 GET 127.0.0.1:9200/markcorp/employee/123
 使用 docker 建立 elastisearch 服務 接下來的教學可以直接用這個專案來直接執行:
git clone https://github.com/h091237557/docker-composer-tools.git cd elasticsearch/ docker-compose up 下面為官網所直接使用的docker compose的檔案。(官網傳送門)
version: &amp;#39;2.|Describe what your web page is about">
    

    <meta name="apple-mobile-web-app-title" content="拿鐵派的馬克 Blog">
    
    
    <link rel="icon" href="/favicon-64.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="mask-icon" size="any" href="/pinned-icon.svg">
    
    
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@your_twitter_id">
    <meta name="twitter:creator" content="@your_twitter_id">
    <meta name="twitter:title" content="Elasticserach 的操作新手村 | 拿鐵派的馬克 Blog">
    <meta name="twitter:description" content="本篇文章中，我們將要很快速的學習以下幾個重點:
 elasticsearch 的基本觀念。 使用 docker 建立 elastisearch 服務。 新增 document。 取得 document。 修改 document。 搜尋 document。  elasticsearch 的基本觀念 Elasticserach 是一種分散式的搜尋引擎，它非常適合用來處理大量資料的搜尋與分析，像 github 就是拿他來搜尋它們所有的程式碼，而且它也提供了豐富的 restful api 來給我們進行操作。
Elasticserach 有這和關聯式資料庫相似的結構，如下圖。
所以假設我們要新增一筆在 markcorp 某一位員工的文檔會長的如下:
index: markcorp type: employee { id: 123 name: ‘Mark’, age: 18 } 然後當我們要去 ES 尋找這筆資料時，就可以使用它提供的 Restful API 來直接尋找:
 GET 127.0.0.1:9200/markcorp/employee/123
 使用 docker 建立 elastisearch 服務 接下來的教學可以直接用這個專案來直接執行:
git clone https://github.com/h091237557/docker-composer-tools.git cd elasticsearch/ docker-compose up 下面為官網所直接使用的docker compose的檔案。(官網傳送門)
version: &#39;2.|Describe what your web page is about">
    <meta name="twitter:image" content="https://mark-lin.comtwitter-card.png">
    
    <meta name="author" content="marklin">
    <meta name="author" content="mark lin">
    <meta name="author" content="馬克">
    <meta name="author" content="拿鐵派">
    <meta name="author" content="拿鐵派的馬克">


    <link rel="stylesheet" href="/assets/syntax-1.1.css">
    <link rel="stylesheet" href="/assets/primer-build.css">
    <link rel="stylesheet" href="/assets/style-1.7.css">
  </head>


  <body>
        <div id="header" class="px-1 bg-white">
                <nav class="UnderlineNav--right px-2 container-lg">
  <div class="logo">
      <a class="log-main UnderlineNav-actions" href="https://mark-lin.com">
          拿鐵派的馬克 Blog
        </a>
      <span class="logo-small">拿鐵才是王道</span>
  </div>

  
  
</nav>
<div class='header-addd' style='width:600px;height:100px !important'> 
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
     style="display:inline-block;width:600px;height:100px"
     data-ad-client="ca-pub-6564736746698681"
     data-ad-slot="8706832635"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>



              </div>
    <div id="holy" class="container-lg bg-white h-100">



      <div role="main" id="main" class="holy-main markdown-body px-4">
        




<div class="Subhead">
  <div class="Subhead-heading">
    <div class="h1 mt-3 mb-1">Elasticserach 的操作新手村</div>
  </div>
  <div class="Subhead-description">
    




<a href='/tags/elasticsearch' class="muted-link">
  <span class="Label Label--gray">elasticsearch</span>
</a>



    
    <div class="float-md-right">
      <span title="Lastmod: 2019-12-26. Published at: 2018-04-01.">
        
          Lastmod: 2019-12-26
        
      </span>
    </div>
    
  </div>
</div>
<article>
  
  <section class="pb-6 mb-3 border-bottom">
    <p>本篇文章中，我們將要很快速的學習以下幾個重點:</p>
<ol>
<li>elasticsearch 的基本觀念。</li>
<li>使用 docker 建立 elastisearch 服務。</li>
<li>新增 document。</li>
<li>取得 document。</li>
<li>修改 document。</li>
<li>搜尋 document。</li>
</ol>
<h2 id="elasticsearch-">elasticsearch 的基本觀念</h2>
<p>Elasticserach 是一種分散式的搜尋引擎，它非常適合用來處理大量資料的搜尋與分析，像 github 就是拿他來搜尋它們所有的程式碼，而且它也提供了豐富的 restful api 來給我們進行操作。</p>
<p>Elasticserach 有這和關聯式資料庫相似的結構，如下圖。</p>
<p><img src="http://yixiang8780.com/outImg/20180411-01-elasticsearch.png" alt=""></p>
<p>所以假設我們要新增一筆在 markcorp 某一位員工的文檔會長的如下:</p>
<pre><code>index: markcorp
type: employee

{
  id: 123
  name: ‘Mark’,
  age: 18
}
</code></pre><p>然後當我們要去 ES 尋找這筆資料時，就可以使用它提供的 Restful API 來直接尋找:</p>
<blockquote>
<p>GET 127.0.0.1:9200/markcorp/employee/123</p>
</blockquote>
<h2 id="-docker--elastisearch-">使用 docker 建立 elastisearch 服務</h2>
<p>接下來的教學可以直接用這個專案來直接執行:</p>
<pre><code>git clone https://github.com/h091237557/docker-composer-tools.git
cd elasticsearch/
docker-compose up
</code></pre><p>下面為官網所直接使用的<code>docker compose</code>的檔案。(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html">官網傳送門</a>)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">version: <span style="color:#e6db74">&#39;2.2&#39;</span>
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:<span style="color:#ae81ff">6.2</span><span style="color:#ae81ff">.3</span>
    container_name: elasticsearch
    environment:
      - cluster.name=docker-cluster
      - bootstrap.memory_lock=<span style="color:#66d9ef">true</span>
      - <span style="color:#e6db74">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span>
    ulimits:
      memlock:
        soft: -<span style="color:#ae81ff">1</span>
        hard: -<span style="color:#ae81ff">1</span>
    volumes:
      - esdata1:/usr/share/elasticsearch/data
    ports:
      - <span style="color:#ae81ff">9200</span>:<span style="color:#ae81ff">9200</span>
    networks:
      - esnet
  elasticsearch2:
    image: docker.elastic.co/elasticsearch/elasticsearch:<span style="color:#ae81ff">6.2</span><span style="color:#ae81ff">.3</span>
    container_name: elasticsearch2
    environment:
      - cluster.name=docker-cluster
      - bootstrap.memory_lock=<span style="color:#66d9ef">true</span>
      - <span style="color:#e6db74">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span>
      - <span style="color:#e6db74">&#34;discovery.zen.ping.unicast.hosts=elasticsearch&#34;</span>
    ulimits:
      memlock:
        soft: -<span style="color:#ae81ff">1</span>
        hard: -<span style="color:#ae81ff">1</span>
    volumes:
      - esdata2:/usr/share/elasticsearch/data
    networks:
      - esnet

volumes:
  esdata1:
    driver: local
  esdata2:
    driver: local

networks:
  esnet:
</code></pre></div><p>以下有幾個配置要注意一下。</p>
<h3 id="environment">environment</h3>
<ul>
<li>cluster.name : 這個就是設定這個 ES cluster 的名稱，所有在相同機器上且命名相同 cluster.name 的都將在相同的 cluster 裡。</li>
<li>bootstrap.memory_lock : 這個設定 true 是為了要防止 swapping 抓到 ES 的 memory 來用，導致節點不穩而脫離 cluster。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/setup-configuration-memory.html">官網</a></li>
<li>ES_JAVA_OPTS: <code>-Xms512m -Xmx512m</code> 代表設定 ES 的最大與最小的 heap 空間為 512 mb。</li>
<li>discovery.zen.ping.unicast.hosts: 這是為了讓此節點知道去連結 elasticsearch ( docker 節點 )。</li>
</ul>
<h3 id="ulimits">ulimits</h3>
<p>這個參數就是可以設定 docker 容器的 ulimits 參數，其中官網這裡會設定 memlock，事實上我還在研究它。不過主要事實和上面的 bootstrap.memory_lock 的原因有關，待調查。</p>
<pre><code>ulimits:
      memlock:
        soft: -1
        hard: -1
</code></pre><h3 id="-elasticsearch-">確保 Elasticsearch 有成功執行</h3>
<p>請指定執行下面的執令，然後該會看到如下的資訊。</p>
<pre><code>curl 127.0.0.1:9200

---
{
  &quot;name&quot; : &quot;OcaPXYM&quot;,
  &quot;cluster_name&quot; : &quot;docker-cluster&quot;,
  &quot;cluster_uuid&quot; : &quot;Cg2ogE6ETbOhSEh0E8m-3w&quot;,
  &quot;version&quot; : {
    &quot;number&quot; : &quot;6.2.3&quot;,
    &quot;build_hash&quot; : &quot;c59ff00&quot;,
    &quot;build_date&quot; : &quot;2018-03-13T10:06:29.741383Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;7.2.1&quot;,
    &quot;minimum_wire_compatibility_version&quot; : &quot;5.6.0&quot;,
    &quot;minimum_index_compatibility_version&quot; : &quot;5.0.0&quot;
  },
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
}
</code></pre><h2 id="heading">新增與取得文檔</h2>
<p>我們試這新增一筆 markcorp 的一筆員工資料看看，上面有提到 ES 提供了 restful api 給我們操作，所以我們只要準備好員工資料的 json 檔。</p>
<pre><code>{
  name: 'Mark',
  age: 18,
  habit: 'Cut someone' 
}
</code></pre><p>然後使用 curl 執行下面的指令就可以新增一筆資料到裡面囉。</p>
<pre><code>curl -X POST -H &quot;Content-Type: application/json&quot; -d @./post.json 127.0.0.1:9200/markcorp/employee

執行完的訊息
{&quot;_index&quot;:&quot;markcorp&quot;,&quot;_type&quot;:&quot;employee&quot;,&quot;_id&quot;:&quot;Mmbls2IBnSbSo4fQfVml&quot;,&quot;_version&quot;:1,&quot;result&quot;:&quot;created&quot;,&quot;_shards&quot;:{&quot;total&quot;:2,&quot;successful&quot;:1,&quot;failed&quot;:0},&quot;_seq_no&quot;:0,&quot;_primary_term&quot;:1}%

</code></pre><p>上面的指令重點有兩個，第一個就是<code>post</code>在 restful api 中就代表這<code>新增</code>的意思，然後第二個重點就是下面這段 uri ，它說明了這筆資料要新增的地點，markcorp 就是 index 而 employee 就是 type 的意思。</p>
<pre><code>127.0.0.1:9200/markcorp/employee
</code></pre><p>然後我們就可以使用下面的 restful api 來取得該筆資料，其中 employee 後面的那個英文就是文檔 id。</p>
<pre><code>curl 127.0.0.1:9200/markcorp/employee/Mmbls2IBnSbSo4fQfVml?pretty

執行完結果
{
  &quot;_index&quot; : &quot;markcorp&quot;,
  &quot;_type&quot; : &quot;employee&quot;,
  &quot;_id&quot; : &quot;Mmbls2IBnSbSo4fQfVml&quot;,
  &quot;_version&quot; : 1,
  &quot;found&quot; : true,
  &quot;_source&quot; : {
    &quot;name&quot; : &quot;Mark&quot;,
    &quot;age&quot; : 18,
    &quot;habit&quot; : &quot;cut someone&quot;
  }
}
</code></pre><h2 id="heading1">更新文檔</h2>
<p>更新文檔的方法也是相同的，使用 put 方法，然後在指定要更新誰就可以囉。</p>
<pre><code>127.0.0.1:9200/markcorp/employee/Mmbls2IBnSbSo4fQfVml
</code></pre><pre><code>curl -X PUT -H &quot;Content-Type: application/json&quot; -d @./update.json 127.0.0.1:9200/markcorp/employee/Mmbls2IBnSbSo4fQfVml?pretty

{
  &quot;_index&quot; : &quot;markcorp&quot;,
  &quot;_type&quot; : &quot;employee&quot;,
  &quot;_id&quot; : &quot;Mmbls2IBnSbSo4fQfVml&quot;,
  &quot;_version&quot; : 3,
  &quot;result&quot; : &quot;updated&quot;,
  &quot;_shards&quot; : {
    &quot;total&quot; : 2,
    &quot;successful&quot; : 2,
    &quot;failed&quot; : 0
  },
  &quot;_seq_no&quot; : 2,
  &quot;_primary_term&quot; : 1
}
</code></pre><h2 id="heading2">搜尋文檔</h2>
<p>假設我們現在有兩筆資料。</p>
<pre><code>{
  name: &quot;Mark&quot;,
  age: 18,
  habit: &quot;cut someone&quot;
},
{
  name: &quot;Ian&quot;,
  age: 18,
  habit: &quot;hack someone&quot;

}
</code></pre><p>然後我們現在要搜尋興趣為<code>cut</code>的員工，就執行下面的指令。</p>
<pre><code>curl 127.0.0.1:9200/markcorp/employee/_search?q=habit:'cut'

---
執行結果

{
    &quot;took&quot;: 146,
    &quot;timed_out&quot;: false,
    &quot;_shards&quot;: {
        &quot;total&quot;: 5,
        &quot;successful&quot;: 5,
        &quot;skipped&quot;: 0,
        &quot;failed&quot;: 0
    },
    &quot;hits&quot;: {
        &quot;total&quot;: 1,
        &quot;max_score&quot;: 0.2876821,
        &quot;hits&quot;: [
            {
                &quot;_index&quot;: &quot;markcorp&quot;,
                &quot;_type&quot;: &quot;employee&quot;,
                &quot;_id&quot;: &quot;YGYhtGIBnSbSo4fQe2Lh&quot;,
                &quot;_score&quot;: 0.2876821,
                &quot;_source&quot;: {
                    &quot;name&quot;: &quot;Mark&quot;,
                    &quot;age&quot;: 18,
                    &quot;habit&quot;: &quot;cut someone&quot;
                }
            }
        ]
    }
}

</code></pre><p>上面的搜尋是最最基本的搜尋，elasticserach 他提供了非常強大的分析與搜尋工具，將留到下一篇文章中來說明。</p>

  </section>

  <section>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mark-lin" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  </section>

</article>
<div class="disqus markdown">
    <div id="disqus_thread"></div>
<script>





(function() { 
var d = document, s = d.createElement('script');
s.src = 'https://mark-lin.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  </div>

      </div>

      <div id="side" class="pr-1">
        <aside class="pr-3">
          
  
    <div id="toc" class="Box Box--blue mb-3">
      <b>Elasticserach 的操作新手村</b><nav id="TableOfContents">
  <ul>
    <li><a href="#elasticsearch-">elasticsearch 的基本觀念</a></li>
    <li><a href="#-docker--elastisearch-">使用 docker 建立 elastisearch 服務</a>
      <ul>
        <li><a href="#environment">environment</a></li>
        <li><a href="#ulimits">ulimits</a></li>
        <li><a href="#-elasticsearch-">確保 Elasticsearch 有成功執行</a></li>
      </ul>
    </li>
    <li><a href="#heading">新增與取得文檔</a></li>
    <li><a href="#heading1">更新文檔</a></li>
    <li><a href="#heading2">搜尋文檔</a></li>
  </ul>
</nav></div>
  

  
    <div>
      
    </div>
  

        </aside>
      </div>

      <div id="footer" class="pt-2 pb-3 text-center">
        




      </div>
    </div>

    
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>
    
  </body>
</html>

<!DOCTYPE html>
<html>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154360458-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154360458-1');
</script>
  <head>
      <script data-ad-client="ca-pub-6564736746698681" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  30-19之MongoDB運用研究---PO文模擬情境(2) &ndash; 拿鐵派的馬克 Blog

    </title>
    
    <meta content="mongodb, nosql, it鐵人賽, 30天之你好MongoDB" name="keywords">
    
    
    <meta name="description" property="og:description" content="上篇文章中，咱們已經將資料都建立好了，也完成了第一個需求，使用者可以進行PO文，並且我們建立出了模擬資料共一百萬筆，大約1gb的大小，接下來|Describe what your web page is about">
    

    <meta name="apple-mobile-web-app-title" content="拿鐵派的馬克 Blog">
    
    
    <link rel="icon" href="/favicon-64.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="mask-icon" size="any" href="/pinned-icon.svg">
    
    
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@your_twitter_id">
    <meta name="twitter:creator" content="@your_twitter_id">
    <meta name="twitter:title" content="30-19之MongoDB運用研究---PO文模擬情境(2) | 拿鐵派的馬克 Blog">
    <meta name="twitter:description" content="上篇文章中，咱們已經將資料都建立好了，也完成了第一個需求，使用者可以進行PO文，並且我們建立出了模擬資料共一百萬筆，大約1gb的大小，接下來|Describe what your web page is about">
    <meta name="twitter:image" content="https://mark-lin.comtwitter-card.png">
    
    <meta name="author" content="marklin">
    <meta name="author" content="mark lin">
    <meta name="author" content="馬克">
    <meta name="author" content="拿鐵派">
    <meta name="author" content="拿鐵派的馬克">


    <link rel="stylesheet" href="/assets/syntax-1.1.css">
    <link rel="stylesheet" href="/assets/primer-build.css">
    <link rel="stylesheet" href="/assets/style-1.4.css">
  </head>


  <body>
        <div id="header" class="px-1 bg-white">
                <nav class="UnderlineNav--right px-2 container-lg">
  <div class="logo">
      <a class="log-main UnderlineNav-actions" href="https://mark-lin.com">
          拿鐵派的馬克 Blog
        </a>
      <span class="logo-small">拿鐵才是王道</span>
  </div>


  
  
</nav>

              </div>
    <div id="holy" class="container-lg bg-white h-100">



      <div role="main" id="main" class="holy-main markdown-body px-4">
        




<div class="Subhead">
  <div class="Subhead-heading">
    <div class="h1 mt-3 mb-1">30-19之MongoDB運用研究---PO文模擬情境(2)</div>
  </div>
  <div class="Subhead-description">
    




<a href='/tags/it-%E9%90%B5%E4%BA%BA%E8%B3%BD-2016' class="muted-link">
  <span class="Label Label--gray">IT 鐵人賽 2016</span>
</a>

<a href='/tags/mongodb' class="muted-link">
  <span class="Label Label--gray">mongodb</span>
</a>



    
    <div class="float-md-right">
      <span title="Lastmod: 2019-12-14. Published at: 2016-09-19.">
        
          Lastmod: 2019-12-14
        
      </span>
    </div>
    
  </div>
</div>
<article>
  
  <section class="pb-6 mb-3 border-bottom">
    <p>上篇文章中，咱們已經將資料都建立好了，也完成了第一個需求，使用者可以進行<code>PO</code>文，並且我們建立出了模擬資料共一百萬筆，大約<code>1gb</code>的大小，接下來我們這篇文章將繼續完成需求，為了怕讀者們忘了需求，所以還是在貼一次。
</p>
<h2 id="heading">~需求說明~</h2>
<p>我們這邊想要簡單的模擬FB的貼文，我們可以新增貼文或做一些事情，並且我們希望還可以進行一些貼文分析，最後這項模擬會建立在有100萬筆下貼文的情況下，所以我們簡單的先列出我們可以用的功能。</p>
<ol>
<li>使用者可以簡單的新增發文，並且會存放<code>Text</code>、<code>Date</code>、<code>Author</code>、<code>likes</code>、<code>Message</code>。 <code>(完成)</code></li>
<li>建立<code>100</code>萬筆模擬<code>po</code>文。<code>(完成)</code></li>
<li>使用者可以刪除發文。</li>
<li>使用者可以對自已的po文進行更新。</li>
<li>使用者可以進行留言和刪除留言。</li>
<li>使用者可以<code>like</code>發文。</li>
<li>使用者可以根據<code>Text</code>、<code>Author</code>、<code>likes</code>、<code>Date</code>進行搜尋。</li>
<li>管理者可以進行分析個案(那些個案之後再想)</li>
</ol>
<p>以下的步驟不代表上述列表的序號，而只是我們完成這需求的過程。</p>
<h3 id="step5-3-">Step5 (需求3) 使用者可以刪除發文</h3>
<p>這個刪除的方法事實上不太難，使用者只要輸入該<code>po</code>文的<code>objectId</code>就可以進行刪除，當然如果是實際有畫面的當然是直接給你選你要刪除的發文，不會還叫你輸入<code>objectId</code>，程式碼如下。</p>
<pre><code>db.posts.remove ({&quot;_id&quot; : &quot;xxxxxxx&quot;})
</code></pre><p>不過在使用刪除時有些事情也要想一下，如果是指定<code>objectId</code>來刪除，理論上來說只會刪除一個，並且速度很快，因為<code>objectId</code>系統會自動的幫我們建立索引，但如果是其它的<code>query</code>則可能要根據情況來考慮要不要建立索引，來幫助刪除的更快速，並且如果要刪除多筆資料別忘了使用<code>bulk</code>。</p>
<pre><code>var bulk = db.posts.initializeUnorderedBulkOp();
bulk.find( { &quot;name&quot;: &quot;mark&quot; } ).remove();
bulk.execute();
</code></pre><blockquote>
<p>刪除方面可以看看<a href="http://ithelp.ithome.com.tw/articles/10185336">這篇文章</a>來複習複習 ~</p>
</blockquote>
<h3 id="step6-4-po">Step6 (需求4) 使用者可以對自已的po文進行更新</h3>
<p>這個也很<code>easy</code>~，就只是針對它的<code>objectId</code>進行搜尋然後更新就好，在做的過程中我們需要使用修改器<code>$set</code>，它的功能就是只針對指定的欄位進行修改~別忘囉~ ,</p>
<pre><code>db.posts.update({&quot;_id&quot;:&quot;XXXXX&quot;},
	{&quot;$set&quot; : { &quot;text&quot; : &quot;Hello World&quot; }
)
</code></pre><blockquote>
<p>更新複習請看<a href="http://ithelp.ithome.com.tw/articles/10185147">這篇</a>~</p>
</blockquote>
<h3 id="step7-5-po">Step7 (需求5) 使用者可以針對po文進行留言和刪除</h3>
<p>先來回想一下我們的<code>posts</code>結構長啥樣子，如下~</p>
<pre><code>{
	&quot;id&quot; : 1,
	&quot;text&quot; : &quot;XXXXXX&quot;,
	&quot;date&quot; : &quot;20160101&quot;,
	&quot;author&quot; : &quot;mark&quot; ,
	&quot;likes&quot; : 1,
	&quot;messages&quot; : [
		{&quot;author&quot; : &quot;steven&quot; , &quot;msg&quot; : &quot;what fuc.&quot; , &quot;date&quot; :20160101},
		{&quot;author&quot; : &quot;ian&quot; , &quot;msg&quot; : &quot;hello world java&quot;,&quot;date&quot;:20160101}
	]
}
</code></pre><p>所以說我們如果想要留言，嚴格來說是針對該po文的<code>messages</code>陣列欄位，新增一個物件。
還記得陣列欄位的修改器<code>$push</code>嗎 ? 它可以讓我們在該陣列最後面新增個物件。</p>
<pre><code>db.posts.update({ &quot;_id&quot; : &quot;XXXXX&quot;},
	{ &quot;$push&quot; : { 
		&quot;messages&quot; : { &quot;author&quot; : &quot;mark&quot; , 
						  &quot;hello word&quot; , 
						  &quot;date&quot; : 20160101 } 
		} 
	}
)
</code></pre><p>那假如咱們留言打錯了，要刪除掉要著麼做 ? 就用這個修改器<code>$pull</code>針對該留言<code>id</code>就行刪除就OK囉。</p>
<pre><code>db.posts.update({ &quot;_id&quot; : &quot;XXXXX&quot;},
	{&quot;$pull&quot; : { &quot;messages&quot; : { &quot;msgId&quot; : &quot;XXXXXX&quot;}}
})
</code></pre><blockquote>
<p>陣列欄位方面的更新請<a href="http://ithelp.ithome.com.tw/articles/10185254">參考這篇</a>~</p>
</blockquote>
<h3 id="step8--like-6">Step8 使用者可以 like 貼文(需求6)</h3>
<p><code>like</code>這功能，就只是要修改<code>like</code>這欄位的數量，每次執行一次都是<code>+1</code>，這時就很適合使用更新的修改器<code>$inc</code>，完成 ~</p>
<pre><code>db.posts.update({&quot;_id&quot; : &quot;XXXXX&quot;},{ &quot;$inc&quot; : { &quot;likes&quot; :  } })
</code></pre><h3 id="step9--textauthorlikesdate-">Step9 使用者可以根據 Text、Author、likes、Date 進行貼文搜尋。</h3>
<p>嗯……這個需求總算是來囉，搜尋這個需求非常的常見，但可以非常簡單的完成，但也有難到會讓你罵髒話的難，用熊來比喻一下，小時後看起來勾錐勾錐的，但長大時看到牠請快跑並且跑的時後順到求神拜佛一下，不然牠會讓你不要不要的。</p>
<p>開始吧~首先我們要先想想<code>索引</code>要著麼建，咱們可以確定<code>text</code>要用全文索引來建立，因為我們要根據單詞來尋找它，再來是<code>author</code>與<code>date</code>這兩個可以一起建立，並且考慮常排序的欄位我們應該要將建立<code>date</code>先行的索引，因為我們常用來尋找最新或最舊的資料，而<code>likes</code>這獨立建立個索引，因為它排序與搜尋都很常會用到。</p>
<p>根據以上的推論，我們用來建立索引的指令如下。</p>
<pre><code>db.posts.ensureIndex({ &quot;text&quot; : &quot;text&quot; });
db.posts.ensureIndex({ &quot;date&quot; : 1,&quot;author&quot; : 1 });
db.posts.ensureIndex({ &quot;likes&quot; : 1 })
</code></pre><p>確定以上的索引都建立好後，我們可以來試試搜尋了。</p>
<blockquote>
<p>索引方面請參考這三篇</p>
</blockquote>
<ul>
<li><a href="http://ithelp.ithome.com.tw/articles/10185673">30-11之索引(1)&mdash;索引的哩哩扣扣</a></li>
<li><a href="http://ithelp.ithome.com.tw/articles/10185768">30-12之索引(2)&mdash;複合索引的坑</a></li>
<li><a href="http://ithelp.ithome.com.tw/articles/10185871">30-13之索引(3)&mdash;比較特別的索引使用</a></li>
</ul>
<h4 id="-text-">首先是根據 text 來進行搜尋。</h4>
<p>我們來試這搜尋看看，貼文中有<code>dog</code>這單詞的<code>po</code>有多少篇。</p>
<pre><code>db.posts.find({ &quot;$text&quot; : { &quot;$search&quot; : &quot;dog&quot; }}).explain(&quot;executionStats&quot;)
</code></pre><p>結果如下，啊喲~沒想到有<code>607</code>筆，並且只花了<code>4ms</code>的有結果囉~果然有索引就是快。</p>
<p><img src="http://yixiang8780.com/outImg/20161219-1.png" alt=""></p>
<p>但我們發覺回傳筆數太多了，所以限制一下筆數為前10筆就好，這樣就ok囉~</p>
<pre><code>db.posts.find({ &quot;$text&quot; : { &quot;$search&quot; : &quot;dog&quot; }}).limit(10)
</code></pre><p>然後著麼多筆再給他根據日期來排序一下，OK~這需求完成~</p>
<pre><code>db.posts.find({ &quot;$text&quot; : { &quot;$search&quot; : &quot;dog&quot; }})
		.sort({&quot;date&quot; : 1})
		.limit(10)
</code></pre><h4 id="-author-">根據 author 來進行搜尋。</h4>
<p>咱們來試試<code>mark</code>這位潮男po了多少篇文章。</p>
<pre><code>db.posts.find({ &quot;author&quot; : &quot;mark&quot;}).count()
</code></pre><p>啊喲啊唉真夠多的啊~</p>
<pre><code>111786
</code></pre><h4 id="-likes--po-">根據 likes 來找出最受歡迎的 po 文</h4>
<p>如果要找出最受歡迎的po文，也代表<code>likes</code>數最大，那只要用排序然後取第一個就ok囉~</p>
<pre><code>db.posts.find().sort({&quot;likes&quot; : -1}).limit(1)
</code></pre><p><img src="http://yixiang8780.com/outImg/20161219-2.png" alt=""></p>
<h4 id="po">找尋最新的po文</h4>
<p>嗯~這也非常的簡單，如下，結果就懶貼囉……</p>
<pre><code>db.posts.find().sort({&quot;date&quot; : 1}).limit(1)
</code></pre><h2 id="heading1">~結語~</h2>
<p>今天先到這邊，基本上都只是在將前幾篇文章的東西拿來使用，而搜尋方面你只要索引有建立好，那不論是搜尋或排序速度在100萬筆資料下速度都飛快~1秒都不到，從這邊可知索引真的很重要的~</p>
<p><code>P.S</code> 我可以了解被追稿的感覺了，辛苦了所有有被追稿的職業~ <code>+u</code> ~</p>

  </section>

  <section>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mark-lin" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  </section>

</article>
<div class="disqus markdown">
    <div id="disqus_thread"></div>
<script>





(function() { 
var d = document, s = d.createElement('script');
s.src = 'https://mark-lin.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  </div>

      </div>

      <div id="side" class="pr-1">
        <aside class="pr-3">
          
  
    <div id="toc" class="Box Box--blue mb-3">
      <b>30-19之MongoDB運用研究---PO文模擬情境(2)</b><nav id="TableOfContents">
  <ul>
    <li><a href="#heading">~需求說明~</a>
      <ul>
        <li><a href="#step5-3-">Step5 (需求3) 使用者可以刪除發文</a></li>
        <li><a href="#step6-4-po">Step6 (需求4) 使用者可以對自已的po文進行更新</a></li>
        <li><a href="#step7-5-po">Step7 (需求5) 使用者可以針對po文進行留言和刪除</a></li>
        <li><a href="#step8--like-6">Step8 使用者可以 like 貼文(需求6)</a></li>
        <li><a href="#step9--textauthorlikesdate-">Step9 使用者可以根據 Text、Author、likes、Date 進行貼文搜尋。</a></li>
      </ul>
    </li>
    <li><a href="#heading1">~結語~</a></li>
  </ul>
</nav></div>
  

  
    <div>
      
    </div>
  

        </aside>
      </div>

      <div id="footer" class="pt-2 pb-3 text-center">
        




      </div>
    </div>

    
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>
    
  </body>
</html>

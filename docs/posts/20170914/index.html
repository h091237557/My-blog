<!DOCTYPE html>
<html>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154360458-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154360458-1');
</script>
  <head>
      <script data-ad-client="ca-pub-6564736746698681" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  Socket.io 的說話島 &ndash; 拿鐵派的馬克 Blog

    </title>
    
    <meta content="socket, socket.io" name="keywords">
    
    
    <meta name="description" property="og:description" content="socket io 是 nodejs 所提供的套件，它主要可以做的事情就是推播功能。 你想想，假設你要做個股票報價網站，然後當你後端收到新的股價時，你要如何的送到前端 ? 在傳|Describe what your web page is about">
    

    <meta name="apple-mobile-web-app-title" content="拿鐵派的馬克 Blog">
    
    
    <link rel="icon" href="/favicon-64.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="mask-icon" size="any" href="/pinned-icon.svg">
    
    
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@your_twitter_id">
    <meta name="twitter:creator" content="@your_twitter_id">
    <meta name="twitter:title" content="Socket.io 的說話島 | 拿鐵派的馬克 Blog">
    <meta name="twitter:description" content="socket io 是 nodejs 所提供的套件，它主要可以做的事情就是推播功能。 你想想，假設你要做個股票報價網站，然後當你後端收到新的股價時，你要如何的送到前端 ? 在傳|Describe what your web page is about">
    <meta name="twitter:image" content="https://mark-lin.comtwitter-card.png">
    
    <meta name="author" content="marklin">
    <meta name="author" content="mark lin">
    <meta name="author" content="馬克">
    <meta name="author" content="拿鐵派">
    <meta name="author" content="拿鐵派的馬克">


    <link rel="stylesheet" href="/assets/syntax-1.1.css">
    <link rel="stylesheet" href="/assets/primer-build.css">
    <link rel="stylesheet" href="/assets/style-1.5.css">
  </head>


  <body>
        <div id="header" class="px-1 bg-white">
                <nav class="UnderlineNav--right px-2 container-lg">
  <div class="logo">
      <a class="log-main UnderlineNav-actions" href="https://mark-lin.com">
          拿鐵派的馬克 Blog
        </a>
      <span class="logo-small">拿鐵才是王道</span>
  </div>


  
  
</nav>
<div class='header-ad'> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-6564736746698681"
         data-ad-slot="8706832635"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>



              </div>
    <div id="holy" class="container-lg bg-white h-100">



      <div role="main" id="main" class="holy-main markdown-body px-4">
        




<div class="Subhead">
  <div class="Subhead-heading">
    <div class="h1 mt-3 mb-1">Socket.io 的說話島</div>
  </div>
  <div class="Subhead-description">
    




<a href='/tags/instant-messaging' class="muted-link">
  <span class="Label Label--gray">instant messaging</span>
</a>

<a href='/tags/socket.io' class="muted-link">
  <span class="Label Label--gray">socket.io</span>
</a>



    
    <div class="float-md-right">
      <span title="Lastmod: 2019-12-26. Published at: 2017-09-14.">
        
          Lastmod: 2019-12-26
        
      </span>
    </div>
    
  </div>
</div>
<article>
  
  <section class="pb-6 mb-3 border-bottom">
    <p>socket io 是 nodejs 所提供的套件，它主要可以做的事情就是<code>推播功能</code>。</p>
<p>你想想，假設你要做個股票報價網站，然後當你後端收到新的股價時，你要如何的送到前端 ?
在傳統的 server 與 client 架構下，因為只能由 client 向 server 發出請求，而不能由 server 發送新的訊息到 client，所以當時的人們的解決方案就是<code>輪詢</code>，固名思意就是指定時的去 server 找資料。</p>
<p>但這種方案有缺點，你想想，你有可能去 server 抓 10 次資料，它有可能 10 次都有新的資料嗎 ? 不一定對吧 ? 所以最理想的方案一定是從 server 端有新資料就自動推送到 client 端。</p>
<p><code>websocket</code>就是一個由 html 5 所發布的新協議，它就可以做到上面所需要的功能。</p>
<p>那<code>socket.io</code>是啥 ? 它是會根據你的 client 所支援的功能(websocket、comet、長輪詢…)來決定你後端要如何的發送資料，更白話文的說，你不用管你的 client 有沒有支援 websocket，socket.io 一切都自動會處理好，你只要和我說啥時要送資訊到前端就對了。</p>
<h2 id="socketio-">Socket.io 的組成</h2>
<p>請參考筆者的這篇文章。</p>
<p><a href="http://marklin-blog.logdown.com/posts/2906519">Socketio 的架構</a></p>
<h2 id="-client--server-">簡單 client 與 server 的溝通範例</h2>
<p>server 端程式碼如下，這段程式碼當與 client 端建立一條 websocket 連線後，會直接對該條連線傳送個<code>{hello: &quot;world&quot;}</code>訊息。</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">)</span><span class="p">;</span>

<span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">hello</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;my other event&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span><span class="p">)</span><span class="p">;</span>
</code></pre></div><p>前端 :</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;/socket.io/socket.io.js&#34;</span><span class="o">&gt;</span><span class="o">&lt;</span><span class="err">/</span><span class="err">s</span><span class="err">c</span><span class="err">r</span><span class="err">i</span><span class="err">p</span><span class="err">t</span><span class="err">&gt;</span>
<span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
    <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">&#39;http://localhost:8080&#39;</span><span class="p">)</span><span class="p">;</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="p">;</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;my other event&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">my</span><span class="o">:</span> <span class="s1">&#39;data&#39;</span> <span class="p">}</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
<span class="o">&lt;</span><span class="err">/</span><span class="err">s</span><span class="err">c</span><span class="err">r</span><span class="err">i</span><span class="err">p</span><span class="err">t</span><span class="err">&gt;</span>
</code></pre></div><p>這樣就可以完成簡單的推播功能囉。</p>
<h2 id="socketio--rooms--namespaces">Socket.io 的 Rooms 與 Namespaces</h2>
<p>在 socket.io 有兩個很重要的概念<code>rooms</code>與<code>namespaces</code>，這邊你只需要記好一件事，那就是它們兩個存在的原因都是為了<code>分組</code>，把要傳送的訊息，送到你想要的群組中。</p>
<h3 id="namespaces">Namespaces</h3>
<p>我們先看看<code>namespaces</code>，上面的範例中有沒有注意到，我們都是用<code>io</code>來進行所有的操作，假設我們要放送訊息到所有連線的 socket，那我們只要下達該指令 :</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">io</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi I am Mark&#39;</span><span class="p">)</span>
</code></pre></div><p>接下來然後我們也可以使用 rooms 來將 io 裡面的 socket 分類到不同的房間中，所以當我們要傳送指定的訊息到某個房間中只要下達下面的指令 :</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="s1">&#39;全家就是我家&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi I am Mark&#39;</span><span class="p">)</span>
</code></pre></div><p>那這邊我想問問，有沒有辦法建立另一個 io 呢 ? 例如我想建立一個是專門處理股票的 io ，而另一個是專門處理期貨的 io ，這時我們就可以使用<code>namespaces</code>裡的<code>of</code>這方法來處理。</p>
<p>例如我們先來建立一個股價的 namespaces :</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">stock_io</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="s1">&#39;/stock&#39;</span><span class="p">)</span><span class="p">;</span>
</code></pre></div><p>然後我們就可以使用這個<code>stock_io</code>來進行我們上面提到的所有動作。</p>
<blockquote>
<p>namespaces 你可以想成， 子 io ，它可以做所有 io 可以做的事情 (基本上)</p>
</blockquote>
<h3 id="room">Room</h3>
<p>接下來我們來說說<code>rooms</code>，這東東的概念和<code>namespace</code>事實上很像，但記好，<code>rooms 是在 namespaces 底下的</code>。</p>
<p>假設你有一個需求，有3個用戶在用你的股價報價系統，其中兩個是在看 1101 台泥的股價，而其中一個是在看 2330 台積電 的股價，這時你應該要注意，不能將 2330 的股價推到在看 1101 股價的使用者那。</p>
<p>socket.io 的 rooms 的功能就可以解決上面的需求，<code>rooms</code>的功能白話文就是你可以<code>發送訊息到指定的房間</code>，像 1101 就是一個房間，而 2330 就是另一個房間，所以假設有 1101 的訊息要推送，只要針對該 room 的用戶進行推送就夠了。</p>
<h4 id="-">那要如何加入到房間呢 ?</h4>
<p>如下 :</p>
<pre><code>io.on('connection', function(socket){
  socket.join('1101');
});
</code></pre><h4 id="-1">那要如何傳送訊息到指定的房間呢 ?</h4>
<p>如下園式碼，你就可以發送訊息到這個房間裡。注意這邊是用<code>io</code>來發送訊息，上面簡單的範例是用<code>socket.emit</code>來送是因為上面範例只需要發送訊息給那條 socket 連線就好，而這邊我們是要發送給<code>1101 這個 room</code>中的 socket，所以要用<code>io</code>來發送。</p>
<pre><code> io.to('1101').emit('xxxx股價')
</code></pre><h3 id="heading">這兩個的差別</h3>
<p>最後終結一下這兩個的差別</p>
<blockquote>
<p>你可以把 namespace 的功能想成可以建立多個子 io ，不同的子 io 可以處理自已的事情，也代表有自已的 rooms ，io1 與 io2 兩個如果都有 room 為 movie 的，也不會影響到什麼，因為它們是分屬不同的 io 了。</p>
</blockquote>
<h2 id="-socketio--middleware">在 Socket.io 中使用 middleware</h2>
<p>在平常我們 web 開發時，有時後會有下面這種需求 :</p>
<blockquote>
<p>每一個 http 請求進來前，需要先檢查登入狀態</p>
</blockquote>
<p>通常這種時後我們就會建立一個 middleware 來處理登入狀態，這邊要注意 middleware 不是用來專門處理登入的東東，它只是一個概念，它真正的定義如下 :</p>
<blockquote>
<p>middleware 又稱中介層，用來處理所有進入或離開<code>主體</code>前的事務。</p>
</blockquote>
<p>像我們每個 http 請求進到主體前，我們需要先確認它的狀態，又或者是進到主題前就先將 log 寫好，這些都是可以放置到<code>middleware</code>來處理，你只要記好，主體就只做主體要做的事情就好。</p>
<p>當然在 socket.io 中我們也是有這個需求，例如每當要建立 websocket 連線時，要預先處理的事情，我們都可以建立 middleware 來處理。</p>
<p>socket.io 提供<code>use</code>方法來讓我們建立 middleware ，範例程式碼如下 :</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">srv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">)</span><span class="p">(</span><span class="nx">srv</span><span class="p">)</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span><span class="p">{</span>
  <span class="nx">run</span><span class="o">++</span><span class="p">;</span> <span class="c1">// 0 -&gt; 1
</span><span class="c1"></span>  <span class="nx">next</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span><span class="p">)</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io-client&#39;</span><span class="p">)</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span><span class="p">{</span>
  <span class="c1">// run == 2 at this time
</span><span class="c1"></span><span class="p">}</span><span class="p">)</span><span class="p">;</span>

</code></pre></div><p>像上面的官方程式碼中，下面這段就是 midddleware 的使用方法，裡面的 use 就是一個 middleware 方法，在建立 websocket 前會先處理的事情。</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">io</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span><span class="p">{</span>
  <span class="nx">run</span><span class="o">++</span><span class="p">;</span> <span class="c1">// 0 -&gt; 1
</span><span class="c1"></span>  <span class="nx">next</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span><span class="p">)</span><span class="p">;</span>
</code></pre></div><p>所以假設我們需要先處理<code>log 事務</code>與<code>快取事務</code>時，我們程式碼就大概會長如下 :</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">io</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logMiddleWare</span><span class="p">)</span><span class="p">;</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cacheMiddleWare</span><span class="p">)</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">logMiddleWare</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span><span class="p">{</span>
    <span class="nx">寫</span> <span class="nx">log</span> <span class="o">~</span><span class="o">~</span><span class="o">~</span>
    <span class="nx">next</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">cacheMiddleWare</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span><span class="p">{</span>
    <span class="nx">取得暫存資料</span><span class="p">...</span><span class="p">.</span><span class="p">.</span>
    <span class="nx">next</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div><h2 id="heading1">參考資料</h2>
<ul>
<li><a href="https://socket.io/docs/server-api/">SOCKETIO 官網</a></li>
</ul>

  </section>

  <section>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mark-lin" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  </section>

</article>
<div class="disqus markdown">
    <div id="disqus_thread"></div>
<script>





(function() { 
var d = document, s = d.createElement('script');
s.src = 'https://mark-lin.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  </div>

      </div>

      <div id="side" class="pr-1">
        <aside class="pr-3">
          
  
    <div id="toc" class="Box Box--blue mb-3">
      <b>Socket.io 的說話島</b><nav id="TableOfContents">
  <ul>
    <li><a href="#socketio-">Socket.io 的組成</a></li>
    <li><a href="#-client--server-">簡單 client 與 server 的溝通範例</a></li>
    <li><a href="#socketio--rooms--namespaces">Socket.io 的 Rooms 與 Namespaces</a>
      <ul>
        <li><a href="#namespaces">Namespaces</a></li>
        <li><a href="#room">Room</a></li>
        <li><a href="#heading">這兩個的差別</a></li>
      </ul>
    </li>
    <li><a href="#-socketio--middleware">在 Socket.io 中使用 middleware</a></li>
    <li><a href="#heading1">參考資料</a></li>
  </ul>
</nav></div>
  

  
    <div>
      
    </div>
  

        </aside>
      </div>

      <div id="footer" class="pt-2 pb-3 text-center">
        




      </div>
    </div>

    
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>
    
  </body>
</html>
